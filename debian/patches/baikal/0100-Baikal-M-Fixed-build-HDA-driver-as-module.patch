From 0dbd7da16ad306bf4c4eac56a3583af466fa3374 Mon Sep 17 00:00:00 2001
From: Vitaly Miniakhmetov <vitaliy.miniakhmetov@elpitech.ru>
Date: Thu, 7 Oct 2021 12:54:12 +0500
Subject: [PATCH 100/106] Baikal-M: Fixed build HDA driver as module

---
 sound/hda/Kconfig           | 3 +++
 sound/hda/hdac_controller.c | 8 ++++----
 sound/pci/hda/Kconfig       | 3 ++-
 3 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/sound/hda/Kconfig b/sound/hda/Kconfig
index 741179ccbd4e..afbdacf19c80 100644
--- a/sound/hda/Kconfig
+++ b/sound/hda/Kconfig
@@ -16,6 +16,9 @@ config SND_HDA_I915
 	bool
 	select SND_HDA_COMPONENT
 
+config SND_HDA_BAIKAL_M_FLAVOR
+	bool
+
 config SND_HDA_EXT_CORE
        tristate
        select SND_HDA_CORE
diff --git a/sound/hda/hdac_controller.c b/sound/hda/hdac_controller.c
index 8457303be873..c66b299a1481 100644
--- a/sound/hda/hdac_controller.c
+++ b/sound/hda/hdac_controller.c
@@ -31,7 +31,7 @@ static void azx_clear_corbrp(struct hdac_bus *bus)
 			break;
 		udelay(1);
 	}
-#ifndef CONFIG_SND_HDA_BAIKAL_M
+#ifndef CONFIG_SND_HDA_BAIKAL_M_FLAVOR
 	if (timeout <= 0)
 		dev_err(bus->dev, "CORB reset timeout#2, CORBRP = %d\n",
 			snd_hdac_chip_readw(bus, CORBRP));
@@ -81,8 +81,8 @@ void snd_hdac_bus_init_cmd_io(struct hdac_bus *bus)
 	/* set N=1, get RIRB response interrupt for new entry */
 	snd_hdac_chip_writew(bus, RINTCNT, 1);
 
-#ifdef CONFIG_SND_HDA_BAIKAL_M
-	/* response irq not working in Baikal-M HDA controller */ 
+#ifdef CONFIG_SND_HDA_BAIKAL_M_FLAVOR
+	/* response irq not working in Baikal-M HDA controller */
 	snd_hdac_chip_writeb(bus, RIRBCTL, AZX_RBCTL_DMA_EN);
 #else
 	/* enable rirb dma and response irq */
@@ -155,7 +155,7 @@ int snd_hdac_bus_send_cmd(struct hdac_bus *bus, unsigned int val)
 
 	spin_lock_irq(&bus->reg_lock);
 
-#ifdef CONFIG_SND_HDA_BAIKAL_M
+#ifdef CONFIG_SND_HDA_BAIKAL_M_FLAVOR
 	/* force first codec address, because wrong codec init */
 	val |= 0x10000000;
 #endif
diff --git a/sound/pci/hda/Kconfig b/sound/pci/hda/Kconfig
index 8067310bb976..4db012a67081 100644
--- a/sound/pci/hda/Kconfig
+++ b/sound/pci/hda/Kconfig
@@ -47,8 +47,9 @@ config SND_HDA_BAIKAL_M
 	depends on ARCH_BAIKAL
 	select SND_HDA
 	select SND_HDA_ALIGNED_MMIO
+	select SND_HDA_BAIKAL_M_FLAVOR
 	help
-	  Say Y here to support the HDA controller present in Baikal-M 
+	  Say Y here to support the HDA controller present in Baikal-M
 	  SoC
 
 	  This options enables support for the HD Audio controller
-- 
2.33.0

