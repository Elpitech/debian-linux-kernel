From 6c03388ef33681f10909fbb21bda6a83ed6d8bf8 Mon Sep 17 00:00:00 2001
From: Miniakhmetov Vitaly <vitalii.miniakhmetov@t-platforms.ru>
Date: Thu, 3 Jun 2021 17:28:04 +0500
Subject: [PATCH 043/106] Baikal-DT: Applied changes from Baikal SDK 5.2

---
 arch/arm64/boot/dts/baikal/bm-clocks.dtsi |  44 ++++++-
 arch/arm64/boot/dts/baikal/bm-soc.dtsi    | 146 ++++++++++++----------
 2 files changed, 117 insertions(+), 73 deletions(-)

diff --git a/arch/arm64/boot/dts/baikal/bm-clocks.dtsi b/arch/arm64/boot/dts/baikal/bm-clocks.dtsi
index 2ec57b43c322..38946f3d6c10 100644
--- a/arch/arm64/boot/dts/baikal/bm-clocks.dtsi
+++ b/arch/arm64/boot/dts/baikal/bm-clocks.dtsi
@@ -6,7 +6,7 @@
 
 / {
 	/* external oscillator */
-	osc25: oscillator25@0 {
+	osc25: oscillator25 {
 		compatible = "fixed-clock";
 		#clock-cells = <0>;
 		clock-frequency = <25000000>;
@@ -14,7 +14,7 @@ osc25: oscillator25@0 {
 	};
 
 	/* external oscillator */
-	osc27: oscillator27@0 {
+	osc27: oscillator27 {
 		compatible = "fixed-clock";
 		#clock-cells = <0>;
 		clock-frequency = <27000000>;
@@ -123,7 +123,6 @@ cmu_mali: cmu_mali {
 		clock-output-names = "baikal-mali-cmu";
 		#clock-cells = <0>;
 		clocks = <&osc25>;
-		clock-indices = <0>;
 		clock-names = "aclk";
 		cmu-id = <0x2a000000>;
 		max = <800000000>;
@@ -154,7 +153,7 @@ cmu1_xgbe: cmu1_xgbe {
 		cmu-id = <0x30010000>;
 		max = <600000000>;
 		min = <13500000>;
-		clock-frequency = <25187500>;
+		clock-frequency = <25250000>;
 	};
 
 	clocks {
@@ -284,6 +283,43 @@ gpu_clk: gpu_clk {
 			clock-output-names = "gpuclk";
 		};
 
+		gpu_opp_table: opp_table_gpu {
+			compatible = "operating-points-v2", "operating-points-v2-mali";
+
+			opp@400000000 {
+				opp-hz = /bits/ 64 <400000000>;
+				clock-latency-ns = <10000000>;
+			};
+			opp@450000000 {
+				opp-hz = /bits/ 64 <450000000>;
+				clock-latency-ns = <10000000>;
+			};
+			opp@500000000 {
+				opp-hz = /bits/ 64 <500000000>;
+				clock-latency-ns = <10000000>;
+			};
+			opp@550000000 {
+				opp-hz = /bits/ 64 <550000000>;
+				clock-latency-ns = <10000000>;
+			};
+			opp@600000000 {
+				opp-hz = /bits/ 64 <600000000>;
+				clock-latency-ns = <10000000>;
+			};
+			opp@650000000 {
+				opp-hz = /bits/ 64 <650000000>;
+				clock-latency-ns = <10000000>;
+			};
+			opp@700000000 {
+				opp-hz = /bits/ 64 <700000000>;
+				clock-latency-ns = <10000000>;
+			};
+			opp@750000000 {
+				opp-hz = /bits/ 64 <750000000>;
+				clock-latency-ns = <10000000>;
+			};
+		};
+
 		clk_ahb: clk_ahb {
 			compatible = "fixed-clock";
 			#clock-cells = <0>;
diff --git a/arch/arm64/boot/dts/baikal/bm-soc.dtsi b/arch/arm64/boot/dts/baikal/bm-soc.dtsi
index eb7c45fae48f..46f880d15110 100644
--- a/arch/arm64/boot/dts/baikal/bm-soc.dtsi
+++ b/arch/arm64/boot/dts/baikal/bm-soc.dtsi
@@ -64,13 +64,8 @@ aliases {
 		vdu_lvds		= &vdu0;
 	};
 
-	/*
-	 * ! ACHTUNG !
-	 * Enable method for Baikal-M CPU cores is not yet clearly defined
-	 * This "psci" node is left here for compliance with linux DTS bindings
-	 */
 	psci {
-		compatible = "arm,psci-0.2";
+		compatible = "arm,psci-1.0", "arm,psci-0.2";
 		method = "smc";
 	};
 
@@ -78,43 +73,7 @@ cpus {
 		#address-cells = <2>;
 		#size-cells = <0>;
 
-		cpu-map {
-			cluster0 {
-				core0 {
-					cpu = <&CPU0>;
-				};
-				core1 {
-					cpu = <&CPU1>;
-				};
-			};
-
-			cluster1 {
-				core0 {
-					cpu = <&CPU2>;
-				};
-				core1 {
-					cpu = <&CPU3>;
-				};
-			};
-
-			cluster2 {
-				core0 {
-					cpu = <&CPU4>;
-				};
-				core1 {
-					cpu = <&CPU5>;
-				};
-			};
-
-			cluster3 {
-				core0 {
-					cpu = <&CPU6>;
-				};
-				core1 {
-					cpu = <&CPU7>;
-				};
-			};
-		};
+		/* Do not use 'cpu-map'. It leads to wrong topology. */
 
 		CPU0: cpu@0 {
 			device_type = "cpu";
@@ -128,7 +87,7 @@ CPU0: cpu@0 {
 			d-cache-line-size = <64>;
 			d-cache-sets = <256>;
 			clocks = <&cmu_cluster0>;
-			next-level-cache = <&A57_L2>;
+			next-level-cache = <&cluster0_l2>;
 			clock-names = "baikal-ca57_cmu";
 			operating-points-v2 = <&cluster0_opp>;
 		};
@@ -145,7 +104,7 @@ CPU1: cpu@1 {
 			d-cache-line-size = <64>;
 			d-cache-sets = <256>;
 			clocks = <&cmu_cluster0>;
-			next-level-cache = <&A57_L2>;
+			next-level-cache = <&cluster0_l2>;
 			clock-names = "baikal-ca57_cmu";
 			operating-points-v2 = <&cluster0_opp>;
 		};
@@ -162,7 +121,7 @@ CPU2: cpu@100 {
 			d-cache-line-size = <64>;
 			d-cache-sets = <256>;
 			clocks = <&cmu_cluster1>;
-			next-level-cache = <&A57_L2>;
+			next-level-cache = <&cluster1_l2>;
 			clock-names = "baikal-ca57_cmu";
 			operating-points-v2 = <&cluster1_opp>;
 		};
@@ -179,7 +138,7 @@ CPU3: cpu@101 {
 			d-cache-line-size = <64>;
 			d-cache-sets = <256>;
 			clocks = <&cmu_cluster1>;
-			next-level-cache = <&A57_L2>;
+			next-level-cache = <&cluster1_l2>;
 			clock-names = "baikal-ca57_cmu";
 			operating-points-v2 = <&cluster1_opp>;
 		};
@@ -196,7 +155,7 @@ CPU4: cpu@200 {
 			d-cache-line-size = <64>;
 			d-cache-sets = <256>;
 			clocks = <&cmu_cluster2>;
-			next-level-cache = <&A57_L2>;
+			next-level-cache = <&cluster2_l2>;
 			clock-names = "baikal-ca57_cmu";
 			operating-points-v2 = <&cluster2_opp>;
 		};
@@ -213,7 +172,7 @@ CPU5: cpu@201 {
 			d-cache-line-size = <64>;
 			d-cache-sets = <256>;
 			clocks = <&cmu_cluster2>;
-			next-level-cache = <&A57_L2>;
+			next-level-cache = <&cluster2_l2>;
 			clock-names = "baikal-ca57_cmu";
 			operating-points-v2 = <&cluster2_opp>;
 		};
@@ -230,7 +189,7 @@ CPU6: cpu@300 {
 			d-cache-line-size = <64>;
 			d-cache-sets = <256>;
 			clocks = <&cmu_cluster3>;
-			next-level-cache = <&A57_L2>;
+			next-level-cache = <&cluster3_l2>;
 			clock-names = "baikal-ca57_cmu";
 			operating-points-v2 = <&cluster3_opp>;
 		};
@@ -247,16 +206,55 @@ CPU7: cpu@301 {
 			d-cache-line-size = <64>;
 			d-cache-sets = <256>;
 			clocks = <&cmu_cluster3>;
-			next-level-cache = <&A57_L2>;
+			next-level-cache = <&cluster3_l2>;
 			clock-names = "baikal-ca57_cmu";
 			operating-points-v2 = <&cluster3_opp>;
 		};
 
-		A57_L2: l2-cache0 {
+		cluster0_l2: l2-cache0 {
+			compatible = "cache";
+			cache-size = <0x100000>;
+			cache-line-size = <64>;
+			cache-sets = <1024>;
+			cache-unified;
+			cache-level = <2>;
+			next-level-cache = <&l3>;
+		};
+
+		cluster1_l2: l2-cache1 {
 			compatible = "cache";
 			cache-size = <0x100000>;
 			cache-line-size = <64>;
 			cache-sets = <1024>;
+			cache-unified;
+			cache-level = <2>;
+			next-level-cache = <&l3>;
+		};
+
+		cluster2_l2: l2-cache2 {
+			compatible = "cache";
+			cache-size = <0x100000>;
+			cache-line-size = <64>;
+			cache-sets = <1024>;
+			cache-unified;
+			cache-level = <2>;
+			next-level-cache = <&l3>;
+		};
+
+		cluster3_l2: l2-cache3 {
+			compatible = "cache";
+			cache-size = <0x100000>;
+			cache-line-size = <64>;
+			cache-sets = <1024>;
+			cache-unified;
+			cache-level = <2>;
+			next-level-cache = <&l3>;
+		};
+
+		l3: l3-cache {
+			cache-size = <0x800000>;
+			cache-unified;
+			cache-level = <3>;
 		};
 	};
 
@@ -633,7 +631,7 @@ M-flash controller - missing
 		lsdma: dma@202B0000 {
 			compatible = "snps,dma-spear1340";
 			reg = <0x0 0x202B0000 0x0 0x10000>;
-// TODO: interrupts
+			// TODO: interrupts
 			interrupts = <GIC_SPI 9 IRQ_TYPE_LEVEL_HIGH>;
 			dma-channels = <8>;
 			dma-requests = <16>;
@@ -651,7 +649,7 @@ lsdma: dma@202B0000 {
 		/* AVLSP: HDA (202C0000, 10000, SPI_86_H) */
 
 		/* AVLSP: VDU (202D0000, 10000, SPI_144-145_?) */
-		vdu0: vdu_lvds@0x202D0000 {
+		vdu0: vdu_lvds@202D0000 {
 			compatible = "baikal,vdu";
 			reg = <0x0 0x202D0000 0x0 0x1000>;
 			interrupts = <GIC_SPI 112 IRQ_TYPE_LEVEL_HIGH>, /* VDU INTR */
@@ -663,18 +661,35 @@ vdu0: vdu_lvds@0x202D0000 {
 		};
 
 		/* AVLSP: SD/eMMC (202E0000, 10000, SPI_83-84_H) */
-		mmc0: mmc@0x202E0000 {
+		mmc0: mmc@202E0000 {
 			compatible = "snps,dwcmshc-sdhci";
 			reg = <0x0 0x202E0000 0x0 0x10000>;
 			interrupt-parent = <&gic>;
 			interrupts = <GIC_SPI 51 IRQ_TYPE_LEVEL_HIGH>,
 				     <GIC_SPI 52 IRQ_TYPE_LEVEL_HIGH>;
-			bus-width = <4>;
 			clock-names = "bus", "core";
 			clocks = <&cmu0_avlsp 18>, <&cmu0_avlsp 19>;
 			status = "disabled";
-			max-frequency = <10000000>;
-			disable-wp;
+		};
+
+		vdec: vdec@24200000 {
+			compatible = "baikal,d5500-vxd";
+			reg = <0x0 0x24200000 0x0 0x10000>;
+			interrupts = <GIC_SPI 497 IRQ_TYPE_LEVEL_HIGH>;
+			status = "disabled";
+		};
+
+		gpu: gpu@2a200000 {
+			compatible = "arm,mali-midgard", "arm,mali-t628";
+			#cooling-cells = <2>; /* min followed by max */
+			reg = <0x0 0x2a200000 0x0 0x4000>;
+			interrupts = <GIC_SPI 175 IRQ_TYPE_LEVEL_HIGH>,
+			<GIC_SPI 176 IRQ_TYPE_LEVEL_HIGH>,
+			<GIC_SPI 174 IRQ_TYPE_LEVEL_HIGH>;
+			interrupt-names = "job", "mmu", "gpu";
+			clocks = <&cmu_mali>;
+			clock-names = "gpuclk";
+			operating-points-v2 = <&gpu_opp_table>;
 		};
 
 		/* USB MM: USB-2 (2C400000, 100000, SPI_267-268_H, SPI_277_H) */
@@ -684,7 +699,7 @@ usb2: usb2@2C400000 {
 			#address-cells = <2>;
 			#size-cells = <2>;
 			ranges;
-			clocks = <&usb_clk 0>;
+			clocks = <&usb_clk>;
 			clock-names = "usb";
 			dma-coherent;
 
@@ -707,7 +722,7 @@ usb3: usb3@2C500000 {
 			#address-cells = <2>;
 			#size-cells = <2>;
 			ranges;
-			clocks = <&usb_clk 0>;
+			clocks = <&usb_clk>;
 			clock-names = "usb";
 
 			dwc3@2C500000 {
@@ -880,7 +895,7 @@ mdio0: be-mdio {
 			#size-cells = <0>;
 			mdc-pin = <&porta 30 GPIO_ACTIVE_HIGH>;
 			mdio-pin = <&porta 29 GPIO_ACTIVE_HIGH>;
-			clocks = <&gpio_clk 0>;
+			clocks = <&gpio_clk>;
 			clock-names = "gpioclk";
 
 			mv_ch0: ethernet-phy@0C {
@@ -975,7 +990,7 @@ xgmac1: eth3@30220000 {
 		 };
 
 		/* HDMI VDU (30260000, 10000, SPI_361-362_?) */
-		vdu1: vdu_hdmi@0x30260000 {
+		vdu1: vdu_hdmi@30260000 {
 			compatible = "baikal,vdu";
 			reg = <0x0 0x30260000 0x0 0x1000>;
 			interrupts = <GIC_SPI 329 IRQ_TYPE_LEVEL_HIGH>, /* VDU INTR */
@@ -1030,11 +1045,4 @@ hdmi_con: endpoint {
 			};
 		};
 	};
-
-	vdec: vdec {
-		compatible = "baikal,d5500-vxd";
-		reg = <0x0 0x24200000 0x0 0x10000>;
-		interrupts = <GIC_SPI 497 IRQ_TYPE_LEVEL_HIGH>;
-		status = "disabled";
-	};
 };
-- 
2.33.0

